@model PaginatedList<UserViewModel>
@{
    ViewData["Title"] = "Users Management";
}
@using Microsoft.AspNetCore.Identity
@using TestProject.Extentions
@using TestProject.Models.ViewModels
@inject UserManager<ApplicationUser> UserManager

<!-- Combined Search and Filter Form -->
<form asp-action="Users" method="get" id="searchFilterForm">

    <div class="form-group col-md-3">
        <label>Filter by Role:</label>
        <select name="roleFilter"
                asp-items="@(new SelectList(ViewBag.Roles as IEnumerable<SelectListItem>, "Value", "Text", ViewBag.CurrentRoleFilter))"
                class="form-control" onchange="this.form.submit()">
            <option value="">All Roles</option>
        </select>
    </div>

    <div class="form-row">
        <div class="form-group col-md-4">
            <label>Search by Name or Username:</label>
            <input type="text" name="searchTerm"
                   value="@ViewContext.HttpContext.Request.Query["searchTerm"]"
                   class="form-control" placeholder="Enter name/username" />
        </div>

        <div class="form-group col-md-2">
            <button type="submit" class="btn btn-sm btn-primary">Search</button>
            <button type="button" class="btn btn-sm btn-secondary" onclick="clearSearch()">Clear Search</button>
        </div>
    </div>
</form>

<p>@ViewBag.UserCountMessage</p>
<p>@ViewBag.FilteredUserCountMessage</p>

<table class="table">
    <thead>
        <tr>
            <th>Name</th>
            <th>UserName</th>
            <th>Role</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var item in Model)
        {
            <tr>
                <td>@($"{item.User.FirstName} {item.User.LastName}")</td>
                <td>@item.User.UserName</td>
                <td>@item.Role</td>
                <td>
                    <!-- Role Edit Form -->
                    <form asp-action="EditRole" method="post">
                        <input type="hidden" name="userId" value="@item.User.Id" />
                        <select name="newRole" class="form-control">
                            @foreach (var role in ViewBag.Roles as SelectList)
                            {
                                <option value="@role.Value" selected="@(role.Value == item.Role)">
                                    @role.Text
                                </option>
                            }
                        </select>
                        <button type="submit" class="btn btn-sm btn-secondary">Update Role</button>
                    </form>

                    <!-- Delete User Form -->
                    <form asp-action="DeleteUser" method="post" style="display:inline">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="id" value="@item.User.Id" />
                        <button type="submit" class="btn btn-sm btn-danger"
                                onclick="return confirm('Сигурен ли си, че искаш да го изтриеш?')">
                            Delete
                        </button>
                    </form>
                </td>
            </tr>
        }
    </tbody>
</table>

<!-- Pagination -->
@if (Model.HasPreviousPage)
{
    <a asp-action="Users"
       asp-route-pageNumber="@(Model.PageIndex - 1)"
       asp-route-roleFilter="@ViewBag.CurrentRoleFilter"
       asp-route-searchTerm="@ViewContext.HttpContext.Request.Query["searchTerm"]"
       class="btn btn-default">Previous</a>
}
else
{
    <button disabled class="btn btn-default">Previous</button>
}

<span>Page @Model.PageIndex of @Model.TotalPages</span>

@if (Model.HasNextPage)
{
    <a asp-action="Users"
       asp-route-pageNumber="@(Model.PageIndex + 1)"
       asp-route-roleFilter="@ViewBag.CurrentRoleFilter"
       asp-route-searchTerm="@ViewContext.HttpContext.Request.Query["searchTerm"]"
       class="btn btn-default">Next</a>
}
else
{
    <button disabled class="btn btn-default">Next</button>
}

<!-- JavaScript to Clear Search -->
<script>
    function clearSearch() {
        // Clear only the search term input
        document.querySelector('input[name="searchTerm"]').value = '';
        // Submit the form to refresh without search term
        document.getElementById("searchFilterForm").submit();
    }
</script>